<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Interview Session</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f0fdfa 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    .glass {
      background: rgba(255,255,255,0.85);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      backdrop-filter: blur(8px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .gradient-text {
      background: linear-gradient(90deg, #6366f1, #06b6d4, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .chat-bubble-ai {
      background: #6366f1;
      color: #fff;
      border-radius: 1.2rem 1.2rem 1.2rem 0.3rem;
      padding: 1rem 1.2rem;
      margin-bottom: 0.5rem;
      max-width: 80%;
      align-self: flex-start;
      box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
    }
    .chat-bubble-user {
      background: #06b6d4;
      color: #fff;
      border-radius: 1.2rem 1.2rem 0.3rem 1.2rem;
      padding: 1rem 1.2rem;
      margin-bottom: 0.5rem;
      max-width: 80%;
      align-self: flex-end;
      box-shadow: 0 2px 8px 0 rgba(6,182,212,0.08);
    }
    .voice-btn {
      background: #f0fdfa;
      border: 2px solid #06b6d4;
      color: #06b6d4;
      border-radius: 9999px;
      padding: 0.5rem 0.9rem;
      margin-left: 0.5rem;
      transition: background 0.2s, color 0.2s;
    }
    .voice-btn:hover {
      background: #06b6d4;
      color: #fff;
    }
  </style>
</head>
<body class="min-h-screen relative">
  <!-- Animated background shapes -->
  <div class="absolute top-0 left-0 w-72 h-72 bg-blue-200 rounded-full opacity-40 blur-2xl -z-10 animate-pulse"></div>
  <div class="absolute bottom-0 right-0 w-96 h-96 bg-cyan-200 rounded-full opacity-30 blur-2xl -z-10 animate-pulse"></div>
  <div class="absolute top-1/2 left-1/2 w-40 h-40 bg-purple-200 rounded-full opacity-20 blur-2xl -z-10 animate-pulse"></div>

  <div class="flex items-center justify-center min-h-screen">
    <div class="glass p-6 md:p-10 w-full max-w-2xl mx-4 flex flex-col gap-8">
      <!-- Step 1: Candidate Login -->
      <div id="login-section">
        <h2 class="text-3xl md:text-4xl font-extrabold mb-6 gradient-text text-center">Start Your AI Interview</h2>
        <form id="loginForm" class="space-y-4 mb-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700">Candidate ID</label>
            <input type="number" name="c_id" class="w-full border rounded p-3" required>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700">Password</label>
            <input type="password" name="password" class="w-full border rounded p-3" required>
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg shadow-lg hover:bg-blue-700 transition text-lg font-semibold">Show My Interviews</button>
        </form>
        <p id="login-message" class="text-center text-red-600 hidden"></p>
      </div>

      <!-- Step 2: List of Scheduled Interviews -->
      <div id="interview-list-section" class="hidden">
        <h3 class="text-2xl font-bold mb-4 gradient-text text-center">Your Scheduled Interviews</h3>
        <div id="interview-list" class="space-y-4 mb-6">
          <!-- Dummy interviews for now -->
          <div class="flex items-center justify-between bg-blue-50 rounded-lg p-4 shadow">
            <div>
              <div class="font-semibold">Job ID: 101</div>
              <div class="text-gray-600 text-sm">Date: 2025-06-01 | Time: 15:00</div>
            </div>
            <button class="start-interview-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold" data-interview="101">Start</button>
          </div>
          <div class="flex items-center justify-between bg-blue-50 rounded-lg p-4 shadow">
            <div>
              <div class="font-semibold">Job ID: 102</div>
              <div class="text-gray-600 text-sm">Date: 2025-06-03 | Time: 11:30</div>
            </div>
            <button class="start-interview-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold" data-interview="102">Start</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Instructions -->
      <div id="instructions-section" class="hidden">
        <h3 class="text-2xl font-bold mb-4 gradient-text text-center">Instructions</h3>
        <ul class="list-disc pl-6 text-gray-700 mb-6">
          <li>Answer each question honestly and to the best of your ability.</li>
          <li>You can answer using your voice or by typing.</li>
          <li>Questions will be presented as both text and voice.</li>
          <li>Click "Got it!" to begin your interview.</li>
        </ul>
        <div class="flex justify-center">
          <button id="got-it-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700 transition text-lg font-semibold">Got it!</button>
        </div>
      </div>

      <!-- Step 4: Chatbot Interview UI -->
      <div id="chat-section" class="hidden flex flex-col gap-4">
        <div id="chat-window" class="flex flex-col gap-2 mb-4 max-h-80 overflow-y-auto bg-gray-50 rounded-lg p-4 shadow-inner">
          <!-- Chat bubbles will appear here -->
          <div class="chat-bubble-ai flex items-center gap-2">
            <span>Welcome! Let's begin your interview. Ready?</span>
            <button class="voice-btn" title="Play Voice"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19V6l12-2v16l-12-2z"/></svg></button>
          </div>
        </div>
        <form id="chat-form" class="flex gap-2 items-center">
          <input type="text" id="chat-input" class="flex-1 border rounded p-3" placeholder="Type your answer..." autocomplete="off" />
          <button type="button" id="voice-answer-btn" class="voice-btn" title="Record Voice Answer">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="11" r="4"/><path d="M12 15v4m-4 0h8"/></svg>
          </button>
          <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-green-700 transition font-semibold">Send</button>
        </form>
        <div class="flex gap-4 my-4">
          <button id="start-record-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 font-semibold">Start Recording</button>
          <button id="send-record-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 font-semibold" disabled>Send</button>
          <span id="recording-indicator" class="text-red-600 font-bold ml-2 hidden">‚óè Recording...</span>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/recorderjs@0.1.0/dist/recorder.js"></script>
  <script>
    // TTS function
    function speak(text, onEndCallback) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utter = new window.SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        const voices = window.speechSynthesis.getVoices();
        const markVoice = voices.find(v => v.name === "Microsoft Mark - English (United States)");
        if (markVoice) utter.voice = markVoice;
        if (onEndCallback) utter.onend = onEndCallback;
        window.speechSynthesis.speak(utter);
      }
    }

    function ensureVoicesLoaded(callback) {
      let voices = window.speechSynthesis.getVoices();
      if (voices.length) {
        callback();
      } else {
        window.speechSynthesis.onvoiceschanged = callback;
      }
    }

    // Step navigation logic (dummy for now)
    const loginSection = document.getElementById('login-section');
    const interviewListSection = document.getElementById('interview-list-section');
    const instructionsSection = document.getElementById('instructions-section');
    const chatSection = document.getElementById('chat-section');

    // Step 1: Login
    document.getElementById('loginForm').onsubmit = function(e) {
      e.preventDefault();
      loginSection.classList.add('hidden');
      interviewListSection.classList.remove('hidden');
    };

    // Step 2: Show Instructions when "Start" is clicked
    document.querySelectorAll('.start-interview-btn').forEach(btn => {
      btn.onclick = function() {
        interviewListSection.classList.add('hidden');
        instructionsSection.classList.remove('hidden');
      };
    });

    // Step 3: Show Chatbot when "Got it!" is clicked
    document.getElementById('got-it-btn').onclick = function() {
      instructionsSection.classList.add('hidden');
      chatSection.classList.remove('hidden');
      // Speak the first AI message
      const firstAIMsg = chatWindow.querySelector('.chat-bubble-ai span');
      if (firstAIMsg) speak(firstAIMsg.textContent);
    };

    // Step 4: Chatbot UI (dummy, just appends user/AI bubbles)
    const chatWindow = document.getElementById('chat-window');
    document.getElementById('chat-form').onsubmit = function(e) {
      e.preventDefault();
      const input = document.getElementById('chat-input');
      if (!input.value.trim()) return;
      // User bubble
      const userBubble = document.createElement('div');
      userBubble.className = 'chat-bubble-user';
      userBubble.textContent = input.value;
      chatWindow.appendChild(userBubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      input.value = '';
      // Dummy AI response
      setTimeout(() => {
        const aiText = "AI: (dummy) Next question or feedback here.";
        const aiBubble = document.createElement('div');
        aiBubble.className = 'chat-bubble-ai flex items-center gap-2';
        aiBubble.innerHTML = `<span>${aiText}</span>
          <button class="voice-btn" title="Play Voice"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19V6l12-2v16l-12-2z"/></svg></button>`;
        chatWindow.appendChild(aiBubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        speak(aiText);

        // Add event listener for the new voice button
        aiBubble.querySelector('.voice-btn').onclick = function() {
          speak(aiText);
        };
      }, 800);
    };

    // Voice answer button (dummy)
    document.getElementById('voice-answer-btn').onclick = function() {
      const userBubble = document.createElement('div');
      userBubble.className = 'chat-bubble-user';
      userBubble.textContent = '[Voice answer recorded]';
      chatWindow.appendChild(userBubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      // Dummy AI response
      setTimeout(() => {
        const aiText = "AI: (dummy) Next question or feedback here.";
        const aiBubble = document.createElement('div');
        aiBubble.className = 'chat-bubble-ai flex items-center gap-2';
        aiBubble.innerHTML = `<span>${aiText}</span>
          <button class="voice-btn" title="Play Voice"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19V6l12-2v16l-12-2z"/></svg></button>`;
        chatWindow.appendChild(aiBubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        speak(aiText);

        // Add event listener for the new voice button
        aiBubble.querySelector('.voice-btn').onclick = function() {
          speak(aiText);
        };
      }, 800);
    };

    // Add TTS to the initial AI message
    window.addEventListener('DOMContentLoaded', () => {
      const firstAIMsg = chatWindow.querySelector('.chat-bubble-ai span');
      if (firstAIMsg) speak(firstAIMsg.textContent);
      // Add event listener for the initial voice button
      const firstVoiceBtn = chatWindow.querySelector('.voice-btn');
      if (firstVoiceBtn && firstAIMsg) {
        firstVoiceBtn.onclick = function() {
          speak(firstAIMsg.textContent);
        };
      }
    });

    let recorder, audioContext, stream;
    const startBtn = document.getElementById('start-record-btn');
    const sendBtn = document.getElementById('send-record-btn');
    const chatInput = document.getElementById('chat-input');
    const recordingIndicator = document.getElementById('recording-indicator');

    startBtn.onclick = async function() {
      if (!recorder) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const input = audioContext.createMediaStreamSource(stream);
        recorder = new Recorder(input, { numChannels: 1 });
        recorder.record();
        startBtn.disabled = true;
        sendBtn.disabled = false;
        recordingIndicator.classList.remove('hidden');
      }
    };

    sendBtn.onclick = function() {
      if (recorder) {
        recorder.stop();
        startBtn.disabled = false;
        sendBtn.disabled = true;
        recordingIndicator.classList.add('hidden');
        recorder.exportWAV(async function(blob) {
          const formData = new FormData();
          formData.append('audio', blob, 'recording.wav');
          // Send to backend for STT
          const res = await fetch('/api/stt', { method: 'POST', body: formData });
          const data = await res.json();
          chatInput.value = data.transcript || '';
          // Clean up
          recorder.clear();
          recorder = null;
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
          }
          if (audioContext) {
            audioContext.close();
            audioContext = null;
          }
        });
      }
    };
  </script>
</body>
</html>