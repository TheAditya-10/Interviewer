<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Interview Session</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #e0e7ff 0%, #f0fdfa 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    .glass {
      background: rgba(255,255,255,0.85);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      backdrop-filter: blur(8px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .gradient-text {
      background: linear-gradient(90deg, #6366f1, #06b6d4, #22d3ee);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .avatar-shadow {
      box-shadow: 0 8px 32px 0 rgba(99,102,241,0.15);
    }
    .mic-btn.recording {
      background: #ef4444 !important;
      color: #fff !important;
      border-color: #ef4444 !important;
    }
    .mic-btn {
      transition: background 0.2s, color 0.2s, border 0.2s;
    }
  </style>
</head>
<body class="min-h-screen relative">
  <!-- Animated background shapes -->
  <div class="absolute top-0 left-0 w-72 h-72 bg-blue-200 rounded-full opacity-40 blur-2xl -z-10 animate-pulse"></div>
  <div class="absolute bottom-0 right-0 w-96 h-96 bg-cyan-200 rounded-full opacity-30 blur-2xl -z-10 animate-pulse"></div>
  <div class="absolute top-1/2 left-1/2 w-40 h-40 bg-purple-200 rounded-full opacity-20 blur-2xl -z-10 animate-pulse"></div>

  <!-- Centered login, interview list, instructions -->
  <div id="center-ui" class="flex items-center justify-center min-h-screen">
    <div class="glass p-6 md:p-10 w-full max-w-2xl mx-4 flex flex-col gap-8">
      <!-- Step 1: Candidate Login -->
      <div id="login-section">
        <h2 class="text-3xl md:text-4xl font-extrabold mb-6 gradient-text text-center">Start Your AI Interview</h2>
        <form id="loginForm" class="space-y-4 mb-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700">Candidate ID</label>
            <input type="number" name="c_id" class="w-full border rounded p-3" required>
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700">Password</label>
            <input type="password" name="password" class="w-full border rounded p-3" required>
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg shadow-lg hover:bg-blue-700 transition text-lg font-semibold">Show My Interviews</button>
        </form>
        <p id="login-message" class="text-center text-red-600 hidden"></p>
      </div>

      <!-- Step 2: List of Scheduled Interviews -->
      <div id="interview-list-section" class="hidden">
        <h3 class="text-2xl font-bold mb-4 gradient-text text-center">Your Scheduled Interviews</h3>
        <div id="interview-list" class="space-y-4 mb-6"></div>
      </div>

      <!-- Step 3: Instructions -->
      <div id="instructions-section" class="hidden">
        <h3 class="text-2xl font-bold mb-4 gradient-text text-center">Instructions</h3>
        <ul class="list-disc pl-6 text-gray-700 mb-6">
          <li>Answer each question honestly and to the best of your ability.</li>
          <li>You can answer using your voice or by typing.</li>
          <li>Questions will be presented as both text and voice.</li>
          <li>Click "Got it!" to begin your interview.</li>
        </ul>
        <div class="flex justify-center">
          <button id="got-it-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700 transition text-lg font-semibold">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Interview UI (hidden until "Got it!") -->
  <div id="interview-ui" class="hidden fixed inset-0 flex h-screen w-screen z-20 bg-white">
    <!-- Left: Interviewer Avatar -->
    <div class="hidden md:flex flex-col items-center justify-center w-1/2 bg-gradient-to-br from-blue-200 to-cyan-100">
      <img src="https://api.dicebear.com/7.x/bottts/svg?seed=AI-Interviewer" alt="AI Interviewer" class="w-64 h-64 rounded-full avatar-shadow mb-8">
      <h2 class="text-3xl font-bold gradient-text mb-2">AI Interviewer</h2>
      <p class="text-lg text-gray-600 text-center max-w-xs">Your professional interviewer. Answer honestly and confidently!</p>
    </div>
    <!-- Right: Q&A Section -->
    <div class="flex-1 flex flex-col justify-between h-full bg-white">
      <!-- Question Display -->
      <div class="flex flex-col items-center justify-center h-2/5 px-6 pt-12">
        <div id="question-box" class="bg-blue-50 rounded-2xl shadow-lg p-8 w-full max-w-2xl text-2xl text-gray-800 font-semibold text-center min-h-[120px] flex items-center justify-center">
          <span id="current-question">Welcome! We are starting Interview soon...</span>
        </div>
      </div>
      <!-- Answer Input -->
      <div class="flex flex-col items-center justify-center h-2/5 px-6">
        <textarea id="answer-input" rows="5" class="w-full max-w-2xl p-5 text-lg border-2 border-blue-200 rounded-2xl shadow focus:outline-none focus:border-blue-500 resize-none mb-4" placeholder="Type your answer here or use the mic..."></textarea>
        <div class="flex items-center gap-6">
          <button id="mic-btn" class="mic-btn border-2 border-blue-500 text-blue-500 rounded-full w-16 h-16 flex items-center justify-center text-3xl bg-white hover:bg-blue-500 hover:text-white transition" title="Record your answer">
            <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18v2m0 0h-3m3 0h3m-3-2a6 6 0 006-6V9a6 6 0 10-12 0v3a6 6 0 006 6z" />
            </svg>
          </button>
          <button id="send-btn" class="bg-green-600 text-white px-10 py-4 rounded-2xl text-xl font-bold shadow-lg hover:bg-green-700 transition" title="Send your answer">Send</button>
        </div>
        <span id="recording-indicator" class="text-red-600 font-bold mt-3 hidden">‚óè Recording...</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/recorderjs@0.1.0/dist/recorder.js"></script>
  <script>
    // TTS function
    function speak(text, onEndCallback) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utter = new window.SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        const voices = window.speechSynthesis.getVoices();
        const markVoice = voices.find(v => v.name === "Microsoft Mark - English (United States)");
        if (markVoice) utter.voice = markVoice;
        if (onEndCallback) utter.onend = onEndCallback;
        window.speechSynthesis.speak(utter);
      }
    }

    // Step navigation logic
    const loginSection = document.getElementById('login-section');
    const interviewListSection = document.getElementById('interview-list-section');
    const instructionsSection = document.getElementById('instructions-section');
    const centerUI = document.getElementById('center-ui');
    const interviewUI = document.getElementById('interview-ui');

    // Step 1: Login
    document.getElementById('loginForm').onsubmit = async function(e) {
      e.preventDefault();
      const c_id = this.c_id.value;
      const password = this.password.value;
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ c_id, password })
      });
      const data = await res.json();
      if (res.ok) {
        loginSection.classList.add('hidden');
        // Fetch interviews
        const interviewsRes = await fetch('/api/my_interviews');
        const interviews = await interviewsRes.json();
        const listDiv = document.getElementById('interview-list');
        listDiv.innerHTML = '';
        interviews.forEach(iv => {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between bg-blue-50 rounded-lg p-4 shadow';
          div.innerHTML = `<div>
            <div class="font-semibold">Job ID: ${iv.job_id}</div>
            <div class="text-gray-600 text-sm">Date: ${iv.date} | Time: ${iv.time}</div>
          </div>
          <button class="start-interview-btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-semibold" data-interview="${iv.interview_id}">Start</button>`;
          listDiv.appendChild(div);
        });
        interviewListSection.classList.remove('hidden');
      } else {
        document.getElementById('login-message').textContent = data.error || "Login failed";
        document.getElementById('login-message').classList.remove('hidden');
      }
    };

    // Step 2: Show Instructions when "Start" is clicked
    document.getElementById('interview-list').onclick = function(e) {
      if (e.target.classList.contains('start-interview-btn')) {
        sessionStorage.setItem('interview_id', e.target.dataset.interview);
        interviewListSection.classList.add('hidden');
        instructionsSection.classList.remove('hidden');
      }
    };

    // Step 3: Show Interview UI when "Got it!" is clicked
    document.getElementById('got-it-btn').onclick = async function() {
      centerUI.classList.add('hidden');
      interviewUI.classList.remove('hidden');
      // Start interview
      const interview_id = sessionStorage.getItem('interview_id');
      const res = await fetch('/api/interview/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interview_id })
      });
      const data = await res.json();
      window.interviewMessages = data.messages;
      showQuestion(data.question);
    };

    // --- Interview UI logic ---
    const questionBox = document.getElementById('current-question');
    const answerInput = document.getElementById('answer-input');
    const micBtn = document.getElementById('mic-btn');
    const micIcon = document.getElementById('mic-icon');
    const sendBtn = document.getElementById('send-btn');
    const recordingIndicator = document.getElementById('recording-indicator');
    let isRecording = false, recorder, audioContext, stream;

    function showQuestion(text) {
      questionBox.textContent = text;
      speak(text);
    }

    sendBtn.onclick = async function() {
      const answer = answerInput.value.trim();
      if (!answer) return;
      answerInput.value = '';
      const res = await fetch('/api/interview/answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          answer: answer,
          messages: window.interviewMessages
        })
      });
      const data = await res.json();
      window.interviewMessages = data.messages;
      showQuestion(data.question);
    };

    micBtn.onclick = async function() {
      if (!isRecording) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const input = audioContext.createMediaStreamSource(stream);
        recorder = new Recorder(input, { numChannels: 1 });
        recorder.record();
        isRecording = true;
        micBtn.classList.add('recording');
        micBtn.title = "Stop Recording";
        micIcon.innerHTML = `<rect x="6" y="6" width="12" height="12" rx="3" fill="currentColor"/>`; // Square icon
        recordingIndicator.classList.remove('hidden');
      } else {
        recorder.stop();
        isRecording = false;
        micBtn.classList.remove('recording');
        micBtn.title = "Record your answer";
        micIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18v2m0 0h-3m3 0h3m-3-2a6 6 0 006-6V9a6 6 0 10-12 0v3a6 6 0 006 6z" />`; // Mic icon
        recordingIndicator.classList.add('hidden');
        recorder.exportWAV(async function(blob) {
          const formData = new FormData();
          formData.append('audio', blob, 'recording.wav');
          // Send to backend for STT
          const res = await fetch('/api/stt', { method: 'POST', body: formData });
          const data = await res.json();
          answerInput.value = data.transcript || '';
          // Clean up
          recorder.clear();
          recorder = null;
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
          }
          if (audioContext) {
            audioContext.close();
            audioContext = null;
          }
        });
      }
    };
  </script>
</body>
</html>